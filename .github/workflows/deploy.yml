name: Deploy React App to Homelab

on:
  push:
    branches:
      - main  # Upewnij siÄ™, Å¼e to nazwa Twojej gÅ‚Ã³wnej gaÅ‚Ä™zi (moÅ¼e byÄ‡ 'master')

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, homelab]

    steps:
      # 1. Pobieramy kod
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Diagnostyka Å›rodowiska (Czy Runner widzi Node'a?)
      - name: Check Environment
        run: |
          echo "ğŸ” Sprawdzam wersje narzÄ™dzi..."
          node -v
          npm -v

      # 3. Instalacja zaleÅ¼noÅ›ci
      - name: Install Dependencies
        run: npm install

      # 4. Budowanie aplikacji (Vite)
      - name: Build Project
        run: npm run build

      # 5. DIAGNOSTYKA: PokaÅ¼ co zbudowaÅ‚eÅ› (To nam powie, czy jest folder assets!)
      - name: Debug Build Output
        run: |
          echo "ğŸ“‚ ZawartoÅ›Ä‡ folderu dist (to co leci na serwer):"
          ls -R dist/

      # 6. Czyszczenie serwera WWW
      - name: Clean Nginx Folder
        run: rm -rf /var/www/html/*

      # 7. Wgrywanie plikÃ³w (UÅ¼ywamy skÅ‚adni dist/. Å¼eby skopiowaÄ‡ ukryte pliki i uniknÄ…Ä‡ bÅ‚Ä™dÃ³w)
      - name: Deploy to Nginx
        run: |
          echo "ğŸš€ Kopiowanie plikÃ³w..."
          cp -r dist/. /var/www/html/
          
      # 8. Naprawa uprawnieÅ„ (Å¼eby Nginx mÃ³gÅ‚ czytaÄ‡ pliki)
      - name: Fix Permissions
        run: |
          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html
          echo "âœ… Uprawnienia naprawione!"
