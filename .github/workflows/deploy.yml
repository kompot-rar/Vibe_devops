name: Deploy React App (Multi-Environment)

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, homelab]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- ENVIRONMENT DETECTION ---
      - name: Set Environment Variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "DEPLOY_DIR=/var/www/html" >> $GITHUB_ENV
            echo "ENV_NAME=Production" >> $GITHUB_ENV
          else
            echo "DEPLOY_DIR=/var/www/vibe_dev" >> $GITHUB_ENV
            echo "ENV_NAME=Preview (Dev)" >> $GITHUB_ENV
          fi

      - name: Check Environment Info
        run: |
          echo "Target Environment: ${{ env.ENV_NAME }}"
          echo "Target Directory: ${{ env.DEPLOY_DIR }}"
          echo "Node version:"
          node -v
          npm -v

      - name: Install Dependencies
        run: npm install

      - name: Build Project
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          REACT_APP_ADMIN_PASSWORD: ${{ secrets.REACT_APP_ADMIN_PASSWORD }}
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: npm run build

      - name: Debug Build Output
        run: |
          echo "Content of dist folder:"
          ls -R dist/

      # --- DEPLOYMENT ---
      - name: Ensure Target Directory Exists
        run: sudo mkdir -p ${{ env.DEPLOY_DIR }}

      - name: Clean Target Folder
        run: sudo rm -rf ${{ env.DEPLOY_DIR }}/*

      - name: Deploy to Nginx
        run: |
          echo "Copying files to ${{ env.ENV_NAME }}..."
          sudo cp -r dist/. ${{ env.DEPLOY_DIR }}/

      - name: Fix Permissions
        run: |
          sudo chown -R www-data:www-data ${{ env.DEPLOY_DIR }}
          sudo chmod -R 755 ${{ env.DEPLOY_DIR }}
          echo "Permissions fixed for ${{ env.DEPLOY_DIR }}!"